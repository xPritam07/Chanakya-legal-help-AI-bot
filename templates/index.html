<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chanakya —Legal help chatbot</title>
  <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
  <div class="wrap">
    <div class="chat-card" role="region" aria-label="Chat">
      <header class="chat-head">
        <div class="avatar" aria-hidden="true">
          <!-- Replace src with your generated image path when hosting -->
          <img src="/static/images/Gemini_Generated_Image_m66gy9m66gy9m66g.png" alt="Chanakya avatar">
          <span class="online-dot" title="online"></span>
        </div>
        <div class="head-info">
          <div class="title">Chanakya ⚖️</div>
          <div class="subtitle">I am here to help you with legal advise!</div>
        </div>
      </header>

      <main class="messages" id="messages" aria-live="polite">
        <!-- Messages will be appended here -->
      </main>

      <form id="composer" class="composer" autocomplete="off">
        <input id="textInput" name="msg" type="text" placeholder="Type your message..." required />
        <button type="submit" id="sendBtn" aria-label="Send">
          <span class="send-icon" aria-hidden="true"></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Vanilla JS -->
  <script>
    (function(){
      const composer = document.getElementById('composer');
      const input = document.getElementById('textInput');
      const messages = document.getElementById('messages');

      // Avatar images (you can replace these URLs with local paths)
      const USER_AVATAR = 'https://i.ibb.co/d5b84Xw/Untitled-design.png';
      const BOT_AVATAR = '/static/images/bot.png';

      // format time with leading zeros
      function two(n){ return (n<10? '0'+n : ''+n); }
      function nowTimeStr(){
        const d = new Date();
        return two(d.getHours()) + ':' + two(d.getMinutes());
      }

      // scroll messages container to bottom
      function scrollToBottom(){
        messages.scrollTop = messages.scrollHeight;
      }

      // create and append message elements
      function appendMessage(text, who){
        const row = document.createElement('div');
        row.className = 'row ' + (who === 'user' ? 'user' : 'bot');

        const imgWrap = document.createElement('div');
        imgWrap.className = 'img-msg';
        const img = document.createElement('img');
        img.src = who === 'user' ? USER_AVATAR : BOT_AVATAR;
        img.alt = who === 'user' ? 'You' : 'Bot';
        imgWrap.appendChild(img);

        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
        bubble.innerHTML = escapeHtml(text);
        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = nowTimeStr();
        bubble.appendChild(time);

        // order: for user the img should be right (we use flex row-reverse for .user)
        row.appendChild(imgWrap);
        row.appendChild(bubble);

        messages.appendChild(row);
        scrollToBottom();
      }

      // simple escape to avoid raw HTML injection
      function escapeHtml(s){
        if (!s && s !== 0) return '';
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;')
          .replace(/\n/g, '<br>');
      }

      // sample greeting message on load (optional)
      appendMessage("Hi! I'm Chanakya. How can I help you today?", 'bot');

      // handle submit
      composer.addEventListener('submit', function(ev){
        ev.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        // append user message immediately
        appendMessage(text, 'user');
        input.value = '';
        input.focus();

        // prepare payload (mirrors your original AJAX)
        const payload = new URLSearchParams();
        payload.append('msg', text);

        // POST to /get and expect text response (same as your previous code)
        fetch('/get', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: payload.toString()
        })
        .then(async resp => {
          if (!resp.ok) {
            // try to read text error
            const errText = await resp.text().catch(()=>resp.statusText);
            throw new Error(errText || 'Network response was not ok');
          }
          // assume server sends plain text; if JSON adapt accordingly
          return resp.text();
        })
        .then(data => {
          appendMessage(data, 'bot');
        })
        .catch(err => {
          // show friendly error from bot
          appendMessage("⚠️ Error: " + String(err.message || err), 'bot');
          console.error("Chat request failed:", err);
        });
      });

      // allow pressing Escape to clear input
      input.addEventListener('keydown', function(e){
        if (e.key === 'Escape') input.value = '';
      });

    })();
  </script>
</body>
</html>